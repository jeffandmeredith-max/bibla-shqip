name: Daily Update

on:
  schedule:
    # 9am Albania time year-round:
    # Winter (Nov-Mar, UTC+1): 08:00 UTC = 9am Albania
    - cron: '0 8 * 1,2,3,11,12 *'
    # Summer (Apr-Oct, UTC+2): 07:00 UTC = 9am Albania
    - cron: '0 7 * 4,5,6,7,8,9,10 *'
  workflow_dispatch: # manual trigger from GitHub UI

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: master

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install yt-dlp, ffmpeg, and Deno
        run: |
          pip3 install yt-dlp
          sudo apt-get update -qq && sudo apt-get install -y -qq ffmpeg
          curl -fsSL https://deno.land/install.sh | sh
          echo "$HOME/.deno/bin" >> $GITHUB_PATH

      - name: Write YouTube cookies
        run: printenv COOKIES_RAW > /tmp/cookies.txt
        env:
          COOKIES_RAW: ${{ secrets.COOKIES }}

      - name: Verify cookies file
        run: |
          echo "First line:"
          head -1 /tmp/cookies.txt
          echo "Line count: $(wc -l < /tmp/cookies.txt)"
          echo "File size: $(wc -c < /tmp/cookies.txt)"

      - name: Fetch playlist metadata and update data files
        run: node scripts/fetch-playlist.mjs
        env:
          COOKIES_FILE: /tmp/cookies.txt

      - name: Download audio for any new days
        run: node scripts/download-audio.mjs
        env:
          COOKIES_FILE: /tmp/cookies.txt

      - name: Commit and push any changes
        run: |
          git config user.email "daily-update@github-actions"
          git config user.name "Daily Update"
          git add src/data/ public/audio/
          if git diff --cached --quiet; then
            echo "No changes — everything is up to date."
          else
            git commit -m "chore: daily update $(date +'%Y-%m-%d')"
            git push
            echo "✅ Changes pushed — Cloudflare will rebuild automatically."
          fi
